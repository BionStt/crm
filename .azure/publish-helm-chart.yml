parameters:
  service: ''
  azuresubscription: ''
  azureresourcegroup: ''
  kubernetescluster: ''

jobs:
  - job: Publish_Helm_Chart
    displayName: Publish helm chart
    variables:
      crm.shortcommit: $[dependencies.Prepare_environment.outputs['setGlobalVarStep.crm.shortcommit']]
      crm.helmversion: $[dependencies.Prepare_environment.outputs['setGlobalVarStep.crm.helmversion']]
      crm.kubectlversion: $[dependencies.Prepare_environment.outputs['setGlobalVarStep.crm.kubectlversion']]
    dependsOn: 
    - Prepare_environment
    pool:
      name: default
    steps:
      - task: HelmInstaller@0
        displayName: Helm installer
        inputs:
          helmVersion: $(crm.helmversion)
          kubectlVersion: $(crm.kubectlversion)
          checkLatestKubectl: false
          
      - task: HelmDeploy@0
        displayName: Helm version
        inputs:
          azureSubscription: ${{ parameters.azuresubscription }}
          azureResourceGroup: ${{ parameters.azureresourcegroup }}
          kubernetesCluster: ${{ parameters.kubernetescluster }}
          command: version

      - task: HelmDeploy@0
        displayName: Helm package
        inputs:
          azureSubscription: ${{ parameters.azuresubscription }}
          azureResourceGroup: ${{ parameters.azureresourcegroup }}
          kubernetesCluster: ${{ parameters.kubernetescluster }}
          command: package
          chartPath: k8s/charts/${{ parameters.service }}
          destination: $(Build.ArtifactStagingDirectory)
          arguments: --app-version $(Build.BuildNumber) --version $(Build.BuildNumber)

      - task: PublishBuildArtifacts@1
        inputs:
          pathtoPublish: $(Build.ArtifactStagingDirectory)/${{ parameters.service }}-$(Build.BuildNumber).tgz
          artifactName: helm